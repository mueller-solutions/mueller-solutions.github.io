---
import dayjs from 'dayjs';
import { getCollection } from 'astro:content';

const pages = await Astro.glob('./**/*.astro');

const fullUrl = Astro.url.origin;

const filteredPages = pages.filter((page) => {
  return ['blog', '[slug]', 'booking-confirmed', 'checklist-registration-success', 'contact-success'].every(
    (blockedPage) => !page.url?.includes(blockedPage),
  );
});

const posts = await getCollection('blog', (post) => !post.data.draft);
const orderedPosts = posts.sort((a, b) => new Date(b.data.posted).getTime() - new Date(a.data.posted).getTime());

const lastMod = dayjs(orderedPosts[0].data.posted).toISOString();

Astro.response.headers.set('Content-Type', 'application/xml');
---

<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  {
    filteredPages.map((page) => (
      <url>
        <loc>{`${fullUrl}${page.url?.replace('.html', '')}`}</loc>
      </url>
    ))
  }
  <url>
    <loc>{`${fullUrl}/blog`}</loc>
    <lastmod>{lastMod}</lastmod>
  </url>
  {
    orderedPosts.map((post) => (
      <url>
        <loc>{`${fullUrl}/blog/${post.slug}`}</loc>
        <lastmod>{dayjs(post.data.posted).toISOString()}</lastmod>
      </url>
    ))
  }
</urlset>
